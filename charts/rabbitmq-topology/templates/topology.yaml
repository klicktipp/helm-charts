{{- $clusterRef := .Values.rabbitmq.cluster.name | default (include "rabbitmq-topology.fullname" .) }}
{{- $defaultVhost := include "rabbitmq-topology.default-vhost" . }}
{{- $queueDefaults := .Values.rabbitmq.topology.queueDefaults | default (dict) }}
{{- $queueExchangeDefaults := $queueDefaults.exchange | default (dict) }}
{{- $queueBindingDefaults := $queueDefaults.binding | default (dict) }}
{{- $exchangeDefaults := .Values.rabbitmq.topology.exchangeDefaults | default (dict) }}
{{- $bindingDefaults := .Values.rabbitmq.topology.bindingDefaults | default (dict) }}
{{- $policyDefaults := .Values.rabbitmq.topology.policyDefaults | default (dict) }}
{{- $defaultQueueExchangeEnabled := hasKey $queueExchangeDefaults "enabled" | ternary $queueExchangeDefaults.enabled true }}
{{- $defaultQueueBindingEnabled := hasKey $queueBindingDefaults "enabled" | ternary $queueBindingDefaults.enabled true }}

{{- range $name, $queue := (.Values.rabbitmq.topology.queues | default (dict)) }}
{{- $queueEnabled := hasKey $queue "enabled" | ternary $queue.enabled true }}
{{- if $queueEnabled }}

{{- $queueName := $queue.name | default $name }}
{{- $queueType := $queue.type | default ($queueDefaults.type | default "quorum") }}
{{- $queueDurable := hasKey $queue "durable" | ternary $queue.durable (hasKey $queueDefaults "durable" | ternary $queueDefaults.durable true) }}
{{- $queueAutoDelete := hasKey $queue "autoDelete" | ternary $queue.autoDelete (hasKey $queueDefaults "autoDelete" | ternary $queueDefaults.autoDelete false) }}
{{- $queueVhost := $queue.vhost | default ($queueDefaults.vhost | default $defaultVhost) }}
{{- $queueMetadataName := $queue.metadataName | default ((printf "%s-%s-%s" $clusterRef $queueVhost $queueName) | include "com.klicktipp.slugify-string") }}

---
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: {{ $queueMetadataName | quote }}
  labels:
    {{- include "rabbitmq-topology.labels" $ | nindent 4 }}
spec:
  name: {{ $queueName | quote }}
  type: {{ $queueType | quote }}
  durable: {{ $queueDurable }}
  autoDelete: {{ $queueAutoDelete }}
  vhost: {{ $queueVhost | quote }}
  {{- with $queue.arguments }}
  arguments:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  rabbitmqClusterReference:
    name: {{ $clusterRef | quote }}

{{- $queueExchange := $queue.exchange | default (dict) }}
{{- $queueExchangeEnabled := hasKey $queueExchange "enabled" | ternary $queueExchange.enabled $defaultQueueExchangeEnabled }}
{{- if $queueExchangeEnabled }}
{{- $exchangeName := $queueExchange.name | default $queueName }}
{{- $exchangeType := $queueExchange.type | default ($queueExchangeDefaults.type | default "fanout") }}
{{- $exchangeDurable := hasKey $queueExchange "durable" | ternary $queueExchange.durable (hasKey $queueExchangeDefaults "durable" | ternary $queueExchangeDefaults.durable true) }}
{{- $exchangeAutoDelete := hasKey $queueExchange "autoDelete" | ternary $queueExchange.autoDelete (hasKey $queueExchangeDefaults "autoDelete" | ternary $queueExchangeDefaults.autoDelete false) }}
{{- $queueExchangeMetadataName := $queueExchange.metadataName | default ((printf "%s-%s-%s" $clusterRef $queueVhost $exchangeName) | include "com.klicktipp.slugify-string") }}
---
apiVersion: rabbitmq.com/v1beta1
kind: Exchange
metadata:
  name: {{ $queueExchangeMetadataName | quote }}
  labels:
    {{- include "rabbitmq-topology.labels" $ | nindent 4 }}
spec:
  name: {{ $exchangeName | quote }}
  type: {{ $exchangeType | quote }}
  durable: {{ $exchangeDurable }}
  autoDelete: {{ $exchangeAutoDelete }}
  vhost: {{ $queueVhost | quote }}
  {{- with $queueExchange.arguments }}
  arguments:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  rabbitmqClusterReference:
    name: {{ $clusterRef | quote }}
{{- end }} {{/* END queue exchange */}}

{{- $binding := $queue.binding | default (dict) }}
{{- $queueBindingEnabled := hasKey $binding "enabled" | ternary $binding.enabled $defaultQueueBindingEnabled }}
{{- if $queueBindingEnabled }}
{{- $bindingName := $binding.name | default $queueName }}
{{- $routingKey := $binding.routingKey | default "" }}
{{- $bindingSource := $binding.source | default ($queueExchange.name | default $queueName) }}
{{- $queueBindingMetadataName := $binding.metadataName | default ((printf "%s-%s-%s" $clusterRef $queueVhost $bindingName) | include "com.klicktipp.slugify-string") }}
---
apiVersion: rabbitmq.com/v1beta1
kind: Binding
metadata:
  name: {{ $queueBindingMetadataName | quote }}
  labels:
    {{- include "rabbitmq-topology.labels" $ | nindent 4 }}
spec:
  vhost: {{ $queueVhost | quote }}
  source: {{ $bindingSource | quote }}
  destination: {{ $binding.destination | default $queueName | quote }}
  destinationType: {{ $binding.destinationType | default ($binding.type | default ($queueBindingDefaults.destinationType | default "queue")) | quote }}
  {{- if ne $routingKey "" }}
  routingKey: {{ $routingKey | quote }}
  {{- end }}
  {{- with $binding.arguments }}
  arguments:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  rabbitmqClusterReference:
    name: {{ $clusterRef | quote }}
{{- end }} {{/* END queue binding */}}

{{- end }} {{/* END if queue enabled */}}
{{- end }} {{/* END queue loop */}}

{{- range $name, $exchange := (.Values.rabbitmq.topology.exchanges | default (dict)) }}
{{- $exchangeEnabled := hasKey $exchange "enabled" | ternary $exchange.enabled true }}
{{- if $exchangeEnabled }}
{{- $exchangeName := $exchange.name | default $name }}
{{- $exchangeType := $exchange.type | default ($exchangeDefaults.type | default "fanout") }}
{{- $exchangeDurable := hasKey $exchange "durable" | ternary $exchange.durable (hasKey $exchangeDefaults "durable" | ternary $exchangeDefaults.durable true) }}
{{- $exchangeAutoDelete := hasKey $exchange "autoDelete" | ternary $exchange.autoDelete (hasKey $exchangeDefaults "autoDelete" | ternary $exchangeDefaults.autoDelete false) }}
{{- $exchangeVhost := $exchange.vhost | default ($exchangeDefaults.vhost | default $defaultVhost) }}
{{- $exchangeMetadataName := $exchange.metadataName | default ((printf "%s-%s-%s" $clusterRef $exchangeVhost $exchangeName) | include "com.klicktipp.slugify-string") }}
---
apiVersion: rabbitmq.com/v1beta1
kind: Exchange
metadata:
  name: {{ $exchangeMetadataName | quote }}
  labels:
    {{- include "rabbitmq-topology.labels" $ | nindent 4 }}
spec:
  name: {{ $exchangeName | quote }}
  type: {{ $exchangeType | quote }}
  durable: {{ $exchangeDurable }}
  autoDelete: {{ $exchangeAutoDelete }}
  vhost: {{ $exchangeVhost | quote }}
  {{- with $exchange.arguments }}
  arguments:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  rabbitmqClusterReference:
    {{- if $exchange.rabbitmqClusterReference }}
    {{- toYaml $exchange.rabbitmqClusterReference | nindent 4 }}
    {{- else }}
    name: {{ $clusterRef | quote }}
    {{- end }}
{{- end }} {{/* END if exchange enabled */}}
{{- end }} {{/* END exchanges loop */}}

{{- range $name, $binding := (.Values.rabbitmq.topology.bindings | default (dict)) }}
{{- $bindingEnabled := hasKey $binding "enabled" | ternary $binding.enabled true }}
{{- if $bindingEnabled }}
{{- $bindingName := $binding.name | default $name }}
{{- $bindingVhost := $binding.vhost | default ($bindingDefaults.vhost | default $defaultVhost) }}
{{- $bindingSource := required (printf "rabbitmq.topology.bindings.%s.source is required" $name) $binding.source }}
{{- $bindingDestination := required (printf "rabbitmq.topology.bindings.%s.destination is required" $name) $binding.destination }}
{{- $routingKey := $binding.routingKey | default "" }}
{{- $bindingMetadataName := $binding.metadataName | default ((printf "%s-%s-%s" $clusterRef $bindingVhost $bindingName) | include "com.klicktipp.slugify-string") }}
---
apiVersion: rabbitmq.com/v1beta1
kind: Binding
metadata:
  name: {{ $bindingMetadataName | quote }}
  labels:
    {{- include "rabbitmq-topology.labels" $ | nindent 4 }}
spec:
  vhost: {{ $bindingVhost | quote }}
  source: {{ $bindingSource | quote }}
  destination: {{ $bindingDestination | quote }}
  destinationType: {{ $binding.destinationType | default ($binding.type | default ($bindingDefaults.destinationType | default "queue")) | quote }}
  {{- if ne $routingKey "" }}
  routingKey: {{ $routingKey | quote }}
  {{- end }}
  {{- with $binding.arguments }}
  arguments:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  rabbitmqClusterReference:
    {{- if $binding.rabbitmqClusterReference }}
    {{- toYaml $binding.rabbitmqClusterReference | nindent 4 }}
    {{- else }}
    name: {{ $clusterRef | quote }}
    {{- end }}
{{- end }} {{/* END if binding enabled */}}
{{- end }} {{/* END bindings loop */}}

{{- range $name, $policy := (.Values.rabbitmq.topology.policies | default (dict)) }}
{{- $policyEnabled := hasKey $policy "enabled" | ternary $policy.enabled true }}
{{- if $policyEnabled }}
---
{{- $policyName := $policy.name | default $name }}
{{- $pattern := required (printf "rabbitmq.topology.policies.%s.pattern is required" $name) $policy.pattern }}
{{- $applyTo := required (printf "rabbitmq.topology.policies.%s.applyTo is required" $name) ($policy.applyTo | default $policyDefaults.applyTo) }}
{{- $definition := required (printf "rabbitmq.topology.policies.%s.definition is required" $name) $policy.definition }}
{{- $policyVhost := $policy.vhost | default ($policyDefaults.vhost | default $defaultVhost) }}
{{- $policyMetadataName := $policy.metadataName | default ((printf "%s-%s-%s" $clusterRef $policyVhost $policyName) | include "com.klicktipp.slugify-string") }}
apiVersion: rabbitmq.com/v1beta1
kind: Policy
metadata:
  name: {{ $policyMetadataName | quote }}
  labels:
    {{- include "rabbitmq-topology.labels" $ | nindent 4 }}
    {{- with $policy.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with $policy.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  name: {{ $policyName | quote }}
  vhost: {{ $policyVhost | quote }}
  pattern: {{ $pattern | quote }}
  applyTo: {{ $applyTo | quote }}
  priority: {{ $policy.priority | default ($policyDefaults.priority | default 0) }}
  definition:
    {{- toYaml $definition | nindent 4 }}
  rabbitmqClusterReference:
    {{- if $policy.rabbitmqClusterReference }}
    {{- toYaml $policy.rabbitmqClusterReference | nindent 4 }}
    {{- else }}
    name: {{ $clusterRef | quote }}
    {{- end }}
{{- end }} {{/* END if policy enabled */}}
{{- end }} {{/* END policies loop */}}
