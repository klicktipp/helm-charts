name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - "charts/*/Chart.yaml"

jobs:
  release:
    # depending on default permission settings for your org (contents being read-only or read-write for workloads), you will have to add permissions
    # see: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#modifying-the-permissions-for-the-github_token
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Detect chart version bumps
        id: version_bump
        run: |
          set -euo pipefail

          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.sha }}"
          HAS_BUMP=false

          mapfile -t changed_chart_files < <(
            git diff --name-only "${BEFORE_SHA}" "${AFTER_SHA}" -- 'charts/*/Chart.yaml' || true
          )

          if [ "${#changed_chart_files[@]}" -eq 0 ]; then
            echo "No Chart.yaml changes detected."
          fi

          for file in "${changed_chart_files[@]}"; do
            old_version="$(git show "${BEFORE_SHA}:${file}" 2>/dev/null | awk -F': *' '$1 == "version" { print $2; exit }' || true)"
            new_version="$(awk -F': *' '$1 == "version" { print $2; exit }' "${file}" || true)"

            if [ -n "${new_version}" ] && [ "${new_version}" != "${old_version}" ]; then
              HAS_BUMP=true
              echo "Version bump detected in ${file}: ${old_version:-<none>} -> ${new_version}"
            else
              echo "No version bump in ${file}: ${old_version:-<none>} -> ${new_version:-<none>}"
            fi
          done

          echo "has_bump=${HAS_BUMP}" >> "$GITHUB_OUTPUT"

      - name: Configure Git
        if: steps.version_bump.outputs.has_bump == 'true'
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Add Helm dependency repos
        if: steps.version_bump.outputs.has_bump == 'true'
        run: |
          set -euo pipefail

          mapfile -t repos < <(
            grep -hE '^[[:space:]]*repository:[[:space:]]*https?://[^[:space:]]+' charts/*/Chart.yaml \
              | sed -E 's/^[[:space:]]*repository:[[:space:]]*//' \
              | sort -u
          )

          if [ "${#repos[@]}" -eq 0 ]; then
            echo "No HTTP(S) chart repositories found in Chart.yaml dependencies."
            exit 0
          fi

          i=0
          for repo in "${repos[@]}"; do
            i=$((i + 1))
            name="dep-repo-${i}"
            echo "Adding Helm repo ${name}: ${repo}"
            helm repo add "${name}" "${repo}"
          done

          helm repo update

      - name: Run chart-releaser
        if: steps.version_bump.outputs.has_bump == 'true'
        uses: helm/chart-releaser-action@cae68fefc6b5f367a0275617c9f83181ba54714f # v1.7.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_SKIP_EXISTING: "true"

      - name: Skip release (no chart version bump)
        if: steps.version_bump.outputs.has_bump != 'true'
        run: echo "No chart version bump detected. Skipping release."
