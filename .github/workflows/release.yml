name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - "charts/*/Chart.yaml"

jobs:
  release:
    # depending on default permission settings for your org (contents being read-only or read-write for workloads), you will have to add permissions
    # see: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#modifying-the-permissions-for-the-github_token
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect chart version bumps
        id: version_bump
        run: |
          set -euo pipefail

          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.sha }}"
          HAS_BUMP=false

          mapfile -t changed_chart_files < <(
            git diff --name-only "${BEFORE_SHA}" "${AFTER_SHA}" -- 'charts/*/Chart.yaml' || true
          )

          if [ "${#changed_chart_files[@]}" -eq 0 ]; then
            echo "No Chart.yaml changes detected."
          fi

          for file in "${changed_chart_files[@]}"; do
            old_version="$(git show "${BEFORE_SHA}:${file}" 2>/dev/null | awk -F': *' '$1 == "version" { print $2; exit }' || true)"
            new_version="$(awk -F': *' '$1 == "version" { print $2; exit }' "${file}" || true)"

            if [ -n "${new_version}" ] && [ "${new_version}" != "${old_version}" ]; then
              HAS_BUMP=true
              echo "Version bump detected in ${file}: ${old_version:-<none>} -> ${new_version}"
            else
              echo "No version bump in ${file}: ${old_version:-<none>} -> ${new_version:-<none>}"
            fi
          done

          echo "has_bump=${HAS_BUMP}" >> "$GITHUB_OUTPUT"

      - name: Configure Git
        if: steps.version_bump.outputs.has_bump == 'true'
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Add Helm dependency repos
        if: steps.version_bump.outputs.has_bump == 'true'
        run: |
          set -euo pipefail

          mapfile -t repos < <(
            grep -hE '^[[:space:]]*repository:[[:space:]]*https?://[^[:space:]]+' charts/*/Chart.yaml \
              | sed -E 's/^[[:space:]]*repository:[[:space:]]*//' \
              | sort -u
          )

          if [ "${#repos[@]}" -eq 0 ]; then
            echo "No HTTP(S) chart repositories found in Chart.yaml dependencies."
            exit 0
          fi

          i=0
          for repo in "${repos[@]}"; do
            i=$((i + 1))
            name="dep-repo-${i}"
            echo "Adding Helm repo ${name}: ${repo}"
            helm repo add "${name}" "${repo}"
          done

          helm repo update

      - name: Collect released chart tags
        if: steps.version_bump.outputs.has_bump == 'true'
        run: |
          set -euo pipefail

          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.sha }}"
          : > .release-tags.txt

          mapfile -t changed_chart_files < <(
            git diff --name-only "${BEFORE_SHA}" "${AFTER_SHA}" -- 'charts/*/Chart.yaml' || true
          )

          for file in "${changed_chart_files[@]}"; do
            old_version="$(git show "${BEFORE_SHA}:${file}" 2>/dev/null | awk -F': *' '$1 == "version" { print $2; exit }' | tr -d '"' | tr -d "'" | xargs || true)"
            new_version="$(awk -F': *' '$1 == "version" { print $2; exit }' "${file}" | tr -d '"' | tr -d "'" | xargs || true)"

            if [ -n "${new_version}" ] && [ "${new_version}" != "${old_version}" ]; then
              chart_name="$(basename "$(dirname "${file}")")"
              echo "${chart_name}-${new_version}" >> .release-tags.txt
            fi
          done

      - name: Run chart-releaser
        if: steps.version_bump.outputs.has_bump == 'true'
        uses: helm/chart-releaser-action@v1.7.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_SKIP_EXISTING: "true"
          CR_GENERATE_RELEASE_NOTES: "true"

      - name: Ensure GitHub auto-generated release notes
        if: steps.version_bump.outputs.has_bump == 'true'
        env:
          GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          set -euo pipefail

          if [ ! -f ".release-tags.txt" ]; then
            echo "No release tags file found. Skipping."
            exit 0
          fi

          mapfile -t tags < .release-tags.txt
          if [ "${#tags[@]}" -eq 0 ]; then
            echo "No release tags queued. Skipping."
            exit 0
          fi

          for tag in "${tags[@]}"; do
            [ -z "${tag}" ] && continue
            chart_name="${tag%-*}"
            previous_tag="$(
              git tag --list "${chart_name}-*" --sort=-v:refname \
                | grep -v "^${tag}$" \
                | head -n 1 || true
            )"

            if ! gh release view "${tag}" >/dev/null 2>&1; then
              echo "Release ${tag} does not exist yet. Skipping."
              continue
            fi

            notes_file="$(mktemp)"
            if [ -n "${previous_tag}" ]; then
              gh api \
                -X POST \
                "repos/${GITHUB_REPOSITORY}/releases/generate-notes" \
                -f "tag_name=${tag}" \
                -f "previous_tag_name=${previous_tag}" \
                --jq '.body' > "${notes_file}"
            else
              gh api \
                -X POST \
                "repos/${GITHUB_REPOSITORY}/releases/generate-notes" \
                -f "tag_name=${tag}" \
                --jq '.body' > "${notes_file}"
            fi

            if [ -s "${notes_file}" ]; then
              gh release edit "${tag}" --notes-file "${notes_file}"
              echo "Updated release notes for ${tag}."
            else
              echo "Generated notes are empty for ${tag}. Skipping update."
            fi
            rm -f "${notes_file}"
          done

      - name: Skip release (no chart version bump)
        if: steps.version_bump.outputs.has_bump != 'true'
        run: echo "No chart version bump detected. Skipping release."
